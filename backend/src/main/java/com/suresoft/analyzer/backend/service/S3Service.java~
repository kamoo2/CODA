package com.suresoft.analyzer.backend.service;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.suresoft.analyzer.backend.dto.storage.BucketDto;
import com.suresoft.analyzer.backend.entity.auth.UserEntity;
import com.suresoft.analyzer.backend.entity.storage.BucketEntity;
import com.suresoft.analyzer.backend.exception.ApiException;
import com.suresoft.analyzer.backend.exception.ErrorCode;
import jakarta.transaction.Transactional;
import org.springframework.stereotype.Service;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.*;
import com.suresoft.analyzer.backend.repository.storage.BucketRepository;
import javax.swing.text.html.Option;
import java.net.URI;
import java.time.Instant;
import java.util.*;
import java.util.stream.Collectors;


@Service
public class S3Service {
    private final SecureStorageService secureStorageService;
    private S3Client s3Client;
    private String wasabiEndpoint = "https://s3.ap-northeast-1.wasabisys.com"; // ë„ì¿„ ë¦¬ì „
    private final BucketRepository repository;

    public S3Service(SecureStorageService secureStorageService, BucketRepository repository) {
        this.secureStorageService = secureStorageService;
        this.repository = repository;
    }

    /**
     * AWS Credentials ê²€ì¦ (Access Key & Secret Keyê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸)
     */
    public void validateCredentials(String accessKey, String secretKey) {
        try {
            // Wasabi S3 í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ë„ì¿„ ë¦¬ì „)
            S3Client tempS3Client = S3Client.builder()
                    .credentialsProvider(StaticCredentialsProvider.create(
                            AwsBasicCredentials.create(accessKey, secretKey)))
                    .endpointOverride(URI.create(wasabiEndpoint)) // Wasabi ë¦¬ì „ë³„ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                    .region(Region.AP_NORTHEAST_1) // ë„ì¿„ ë¦¬ì „ ì§€ì •
                    .build();

            // ë²„í‚· ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ê¶Œí•œ í…ŒìŠ¤íŠ¸)
            ListBucketsResponse response = tempS3Client.listBuckets(ListBucketsRequest.builder().build());

        } catch (S3Exception e) {
            // ì˜ˆì™¸ ë°œìƒ
            throw new ApiException(ErrorCode.INVAILD_STORAGE);
        } catch (Exception e) {
            // ë‹¤ë¥¸ ì˜ˆì™¸ ë°œìƒ
            throw new ApiException(ErrorCode.INTERNAL_SERVER_ERROR);
        }
    }

    public List<String> getBucketNameList(String accessKey, String secretKey, String regionStr) {
        try {
            AwsBasicCredentials awsCreds = AwsBasicCredentials.create(accessKey, secretKey);
            Region region = Region.of(regionStr);
            String endpoint = String.format("https://s3.%s.wasabisys.com", regionStr);

            S3Client s3Client = S3Client.builder()
                    .credentialsProvider(StaticCredentialsProvider.create(awsCreds))
                    .endpointOverride(URI.create(endpoint))
                    .region(region)
                    .build();

            ListBucketsResponse response = s3Client.listBuckets();

            return response.buckets().stream()
                    .map(Bucket::name)  // ì´ë¦„ë§Œ ì¶”ì¶œ
                    .collect(Collectors.toList());

        } catch (S3Exception e) {
            throw new ApiException(ErrorCode.INVAILD_STORAGE);
        } catch (Exception e) {
            throw new ApiException(ErrorCode.INTERNAL_SERVER_ERROR);
        }
    }


    /**
     * AWS Keyë¥¼ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
     */
    public void setAwsCredentials(String accessKey, String secretKey, String region, String name, UserEntity user) {
        // Access Key & Secret Key ì•”í˜¸í™” í›„ ì €ì¥
        String encryptedAccessKey = secureStorageService.encrypt(accessKey);
        String encryptedSecretKey = secureStorageService.encrypt(secretKey);

        //ê¸°ì¡´ ë™ì¼í•œ ë²„í‚·ì´ ìˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
        Optional<BucketEntity> existingBucket = repository.findByName(name);
        if (existingBucket.isPresent()) {
            throw new ApiException(ErrorCode.INVAILD_STORAGE ,"ì´ë¯¸ ì €ì¥ë˜ì–´ìˆëŠ” ë²„í‚·ì…ë‹ˆë‹¤.");
        }

        //ìƒˆë¡œìš´ BucketEntity ìƒì„± ë° ì €ì¥
        BucketEntity bucket = new BucketEntity(encryptedAccessKey, encryptedSecretKey, region, name, user);
        repository.save(bucket);

    }


    public List<BucketDto> getUserBuckets(UserEntity user) {
        // ì—¬ëŸ¬ ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ ìˆ˜ì •
        List<BucketEntity> buckets = repository.findAllByUserId(user.getId());

        return buckets.stream()
                .map(bucket -> new BucketDto(
                        bucket.getId(),
                        bucket.getName(),
                        bucket.getRegion(),
                        secureStorageService.getDecryptedValue("accessKey", bucket.getAccessKey()),
                        secureStorageService.getDecryptedValue("secretKey", bucket.getSecretKey()),
                        bucket.getCreatedAt()
                ))
                .collect(Collectors.toList());
    }

    // BucketDto ê¸°ë°˜ìœ¼ë¡œ ë²„í‚· ë””í…Œì¼ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œ
    public BucketDto getBucketDetailByName(UserEntity user, String bucketId) {
        // ì‚¬ìš©ì IDì™€ ë²„í‚· ì´ë¦„ì„ ê¸°ì¤€ìœ¼ë¡œ ë‹¨ì¼ ê²°ê³¼ ì¡°íšŒ
        BucketEntity bucket = repository.findByUserIdAndId(user.getId(), bucketId);

        if (bucket  == null) {
            throw new IllegalStateException(" í•´ë‹¹ ì´ë¦„ì˜ ë²„í‚·ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: " + bucketId);
        }

        // BucketEntityë¥¼ BucketDtoë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜
        return new BucketDto(
                bucket.getId(),
                bucket.getName(),
                bucket.getRegion(),
                secureStorageService.getDecryptedValue("accessKey", bucket.getAccessKey()),
                secureStorageService.getDecryptedValue("secretKey", bucket.getSecretKey()),
                bucket.getCreatedAt()
        );
    }




    /**
     * ì €ì¥ëœ Keyë¥¼ ë³µí˜¸í™”í•˜ì—¬ S3Client ì„¤ì •
     */
    public void initializeS3Client(String bucketName) {
        Optional<BucketEntity> bucketOptional = repository.findByName(bucketName);

        if (bucketOptional.isEmpty()) {
            throw new IllegalStateException(" í•´ë‹¹ ì´ë¦„ì˜ ë²„í‚·ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: " + bucketName);
        }

        BucketEntity bucket = bucketOptional.get();
        String accessKey = secureStorageService.getDecryptedValue("accessKey",bucket.getAccessKey());
        String secretKey = secureStorageService.getDecryptedValue("secretKey",bucket.getSecretKey());

        this.s3Client = S3Client.builder()
                .endpointOverride(URI.create(wasabiEndpoint))
                .credentialsProvider(StaticCredentialsProvider.create(
                        AwsBasicCredentials.create(accessKey, secretKey)
                ))
                .region(Region.AP_NORTHEAST_1)
                .build();

        System.out.println(" Wasabi Storage ì—°ê²° ì™„ë£Œ (" + bucketName + ")");
    }

    /**
     * íŠ¹ì • Wasabi Storage ë²„í‚·ì—ì„œ í´ë”(ë””ë ‰í† ë¦¬) ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
     */
    public Set<String> listFolders(String bucketName, String prefix) {
        if (s3Client == null) {
            initializeS3Client(bucketName);
        }

        ListObjectsV2Request listRequest = ListObjectsV2Request.builder()
                .bucket(bucketName)
                .prefix(prefix)
                .delimiter("/")
                .fetchOwner(true) // Owner(ìƒì„±í•œ ì‚¬ëŒ) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                .build();


        ListObjectsV2Response listResponse = s3Client.listObjectsV2(listRequest);


        return listResponse.commonPrefixes().stream()
                .map(CommonPrefix::prefix)
                .map(folder -> folder.replaceAll("/$", ""))
                .collect(Collectors.toSet());
    }


    public String getBucketAndObjectsInfoAsJson(String bucketName, String prefix) throws Exception {
        if (s3Client == null) {
            initializeS3Client(bucketName);
        }

        // JSON ë³€í™˜ì„ ìœ„í•œ ObjectMapper ìƒì„±
        ObjectMapper objectMapper = new ObjectMapper();
        ObjectNode rootNode = objectMapper.createObjectNode();

        // ğŸ”¹ ë²„í‚· ì†Œìœ ì ë° í¬ê¸° ê°€ì ¸ì˜¤ê¸°
        GetBucketAclResponse bucketAclResponse = s3Client.getBucketAcl(
                GetBucketAclRequest.builder().bucket(bucketName).build()
        );
        rootNode.put("bucketName", bucketName);
        rootNode.put("bucketOwner", bucketAclResponse.owner().displayName());
        rootNode.put("bucketSize", getBucketSize(bucketName));

        // ğŸ”¹ íŒŒì¼ ëª©ë¡ JSON íŠ¸ë¦¬ êµ¬ì¡° ìƒì„±
        ObjectNode filesNode = objectMapper.createObjectNode();
        Map<String, ObjectNode> folderMap = new HashMap<>();
        folderMap.put("", filesNode); // ë£¨íŠ¸ í´ë”

        ListObjectsV2Request listRequest = ListObjectsV2Request.builder()
                .bucket(bucketName)
                .prefix(prefix)
                .fetchOwner(true)
                .build();
        ListObjectsV2Response listResponse = s3Client.listObjectsV2(listRequest);

        for (S3Object s3Object : listResponse.contents()) {
            String filePath = s3Object.key(); // íŒŒì¼ì˜ ì „ì²´ í‚¤(ê²½ë¡œëª…)
            String[] pathParts = filePath.split("/");
            ObjectNode parent = filesNode;
            StringBuilder currentPath = new StringBuilder();

            // ğŸ”¹ í´ë” êµ¬ì¡°ë¥¼ ìƒì„± (ì¬ê·€ ì—†ì´)
            for (int i = 0; i < pathParts.length - 1; i++) {
                currentPath.append(pathParts[i]).append("/");

                // Keyê°€ ì—†ì„ ë•Œë§Œ ê°’ ì¶”ê°€ (í´ë” êµ¬ì¡° ìœ ì§€)
                folderMap.putIfAbsent(currentPath.toString(), objectMapper.createObjectNode());
                parent.set(pathParts[i], folderMap.get(currentPath.toString()));
                parent = folderMap.get(currentPath.toString());
            }

            // ğŸ”¹ íŒŒì¼ ì •ë³´ ì¶”ê°€
            ObjectNode fileNode = objectMapper.createObjectNode();
            fileNode.put("filePath", filePath);  // íŒŒì¼ì˜ ì „ì²´ ê²½ë¡œëª…
            fileNode.put("owner", s3Object.owner() != null ? s3Object.owner().displayName() : "Unknown");
            fileNode.put("lastModified", s3Object.lastModified().toString());
            fileNode.put("fileSize", s3Object.size());

            // ë§ˆì§€ë§‰ ìš”ì†Œê°€ íŒŒì¼ëª…
            parent.set(pathParts[pathParts.length - 1], fileNode);
        }

        rootNode.set("files", filesNode);
        return objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(rootNode);
    }


    public long getBucketSize(String bucketName) {
        long totalSize = 0;
        ListObjectsV2Request request = ListObjectsV2Request.builder()
                .bucket(bucketName)
                .build();

        ListObjectsV2Response response;
        do {
            response = s3Client.listObjectsV2(request);
            totalSize += response.contents().stream()
                    .mapToLong(S3Object::size)
                    .sum();
            request = request.toBuilder()
                    .continuationToken(response.nextContinuationToken())
                    .build();
        } while (response.isTruncated());

        return totalSize;
    }

}